generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  TENANT
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

enum InvoiceStatus {
  PENDING
  VERIFYING
  PAID
  REJECTED
  OVERDUE
}

enum MaintenanceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}



model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      Role     @default(TENANT)
  firstName String
  lastName  String
  phone     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resetPasswordToken   String?  @db.VarChar(255)
  resetPasswordExpires DateTime?

  depositAmount     Decimal? @db.Decimal(10, 2)
  contractStartDate DateTime?
  contractEndDate   DateTime?

  room                Room?                @relation("TenantRoom")
  invoices            Invoice[]
  maintenanceRequests MaintenanceRequest[]
}

model Room {
  id         Int        @id @default(autoincrement())
  roomNumber String     @unique
  baseRent   Decimal    @db.Decimal(10, 2)
  status     RoomStatus @default(AVAILABLE)
  floor      Int        @default(1)
  tenantId   Int?       @unique
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  tenant              User?                @relation("TenantRoom", fields: [tenantId], references: [id])
  meterReadings       MeterReading[]
  invoices            Invoice[]
  maintenanceRequests MaintenanceRequest[]
}

model MeterReading {
  id               Int      @id @default(autoincrement())
  roomId           Int
  waterPrevious    Int      @default(0)
  waterCurrent     Int
  electricPrevious Int      @default(0)
  electricCurrent  Int
  readingDate      DateTime @default(now())
  createdAt        DateTime @default(now())

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId, readingDate])
}

model Invoice {
  id             Int           @id @default(autoincrement())
  roomId         Int
  tenantId       Int
  rentAmount     Decimal       @db.Decimal(10, 2)
  waterUnits     Int           @default(0)
  waterAmount    Decimal       @db.Decimal(10, 2)
  electricUnits  Int           @default(0)
  electricAmount Decimal       @db.Decimal(10, 2)
  totalAmount    Decimal       @db.Decimal(10, 2)
  status         InvoiceStatus @default(PENDING)
  billingMonth   DateTime
  dueDate        DateTime
  paidAt         DateTime?
  slipImage      String?       @db.LongText
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  room   Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tenant User @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([roomId, billingMonth])
  @@index([tenantId, status])
}

model Settings {
  id           Int     @id @default(autoincrement())
  dormName     String  @default("หอพักของฉัน")
  address      String?
  waterRate    Decimal @default(18) @db.Decimal(10, 2)
  electricRate Decimal @default(8) @db.Decimal(10, 2)
  promptPayID   String?
  promptPayName String?
  lineNotifyToken String?
  dormRules     String? @db.Text // Rules to display in contracts
}

model MaintenanceRequest {
  id          Int               @id @default(autoincrement())
  roomId      Int
  tenantId    Int
  title       String
  description String            @db.Text
  imageData   String?           @db.LongText
  status      MaintenanceStatus @default(PENDING)
  adminNote   String?           @db.Text
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  completedAt DateTime?

  room   Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  tenant User @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([roomId, status])
  @@index([tenantId, status])
  @@index([status])
}

enum AnnouncementImportance {
  NORMAL
  URGENT
}

model Announcement {
  id         Int                    @id @default(autoincrement())
  title      String
  content    String                 @db.Text
  importance AnnouncementImportance @default(NORMAL)
  isActive   Boolean                @default(true)
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
}


model Expense {
  id          Int      @id @default(autoincrement())
  title       String
  amount      Decimal  @db.Decimal(10, 2)
  category    String   @default("GENERAL") // e.g., UTILITIES, MAINTENANCE, SUPPLIES
  date        DateTime @default(now())
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
